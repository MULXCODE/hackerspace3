<h2>Bulk Mail Order <%= @bulk_mail.name %> for <%= @event.name %></h2>
<p>Status: <%= @bulk_mail.status %></p>
<p>From Email: <%= @bulk_mail.from_email %></p>
<p>Subject: <%= @bulk_mail.subject %></p>
<p>Created At: <%= @bulk_mail.created_at %></p>

<div>
  <p>>>>></p>
  <%= markdown(BulkMail.correspondence_body(@bulk_mail.body, @example_user, @example_project)) unless @bulk_mail.body.nil? %>
  <p>>>>></p>
</div>

<% unless @bulk_mail.status == PROCESSED %>
  <p><%= link_to 'Edit Bulk Mail', edit_admin_event_bulk_mail_path(@event, @bulk_mail) %></p>
  <p>Current Order: <%= @user_order.request_type.nil? ? 'None Selected' : @user_order.request_type %></p>
  <%= form_for [:admin, @bulk_mail, @user_order] do |form| %>
    <%= form.select(:request_type, options_for_select(USER_ORDER_QUERIES, @user_order.request_type)) %>
    <%= form.submit 'Amend Order' %>
  <% end %>
<% end %>

<table>
  <tr>
    <th>Status</th>
    <th>Display Name</th>
    <% if @bulk_mail.status == PROCESSED %>
      <th>Email Status</th>
    <% end %>
  </tr>
  <% @registrations.each do |registration| %>
    <% assignment = @id_assignments[registration.assignment_id] %>
    <% user = @id_users[assignment.user_id] %>
    <% next unless user.me_govhack_contact %>
    <tr>
      <td><%= registration.status %></td>
      <td><%= user.display_name %></td>
      <% @participant_count += 1 %>
      <% if @bulk_mail.status == PROCESSED %>
        <% correspondence = @id_user_correspondences[user.id] %>
        <td><%= link_to correspondence.status, admin_bulk_mail_correspondence_path(@bulk_mail, correspondence) %></td>
      <% end %>
    </tr>
  <% end %>
</table>

<% if @bulk_mail.status == DRAFT && !@participant_count.zero? %>
  <p><%=
    link_to "Process Mail Orders for #{ pluralize @participant_count, 'Participant'}",
    admin_event_bulk_mail_path(@event, @bulk_mail, process: true), method: :patch,
    data: { confirm: "Are you sure?" }
  %></p>
<% elsif @bulk_mail.status == PROCESS %>
  <p>This Bulk Mail is currently being processed check back shortly.</p>
<% end %>
<%= link_to 'Back to Bulk Mails', admin_event_bulk_mails_path(@event) %>
