<h2>Add New Team Member to <%= @assignable.current_project.team_name %></h2>

<%= form_tag(new_team_assignment_path, method: :get) do %>
  <%= text_field_tag :term, params[:term] %>
  <%= hidden_field_tag(:title, @title) %>
  <%= submit_tag 'Search' %>
<% end %><br>

<% if @user.present? # User found show create new assignment for %>

  <%= render 'admin/shared/user_contact', locals: { user: @user } %>
  <% unless @existing_registration.present? # check for existing registration %>

    <%= form_for [@assignable, @assignment] do |f| %>
      <%= hidden_field_tag(:user_id, @user.id) %>
      <%= hidden_field_tag(:title, @title) %>
      <%= f.submit "Add #{@user.display_name} to #{@assignable.current_project.team_name}" %>
    <% end %>

  <% else %>
    Assignment for <%= @user.display_name %> to <%= @assignable.current_project.team_name %> as <%= @existing_registration.title %> already exists.<br>
  <% end %>

<% elsif params[:term].present? && params[:term].match?(VALID_EMAIL_REGEX) %>

  <div>No current user with email <%= params[:term]%>, save team position for unregisterd user?</div>

  <%= form_for [@assignable, @assignment] do |f| %>
    <%= hidden_field_tag(:email, params[:term]) %>
    <%= hidden_field_tag(:title, @title) %>
    <%= f.submit "Add #{params[:term]} to #{@assignable.current_project.team_name}" %>
  <% end %>

<% elsif @users.present? # Review search results %>

  <% @users.each do |user| %>
    <%= render 'admin/shared/user_contact', locals: { user: user } %>
    <%= link_to 'Select', new_team_assignment_path(@assignable, title: @title, term: user.email) %><br>
  <% end %>

<% elsif params[:term].present? # Could not find anything. %>

  Apologies, no name matching search term '<%= params[:term] %>'<br>

<% else # No search term entered / first visit to page %>

  Please enter an email address or name to search for a user.<br>

<% end %>

<%= link_to "Back to #{@assignable.class.to_s}", team_path(@assignable) %>
